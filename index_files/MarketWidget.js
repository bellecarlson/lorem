/*! updated; 02-27-2018 04:46 PM **/


Modulr.define("core.plugins:MarketWidget",["require","jquery","lodash","MarketFutures"],function(require,$,_){function App(){var marketHolder,Proto=this,defaultStocks=["I:COMP","SP500","I:DJI"],CALL_STACK={};Proto.init=function(opts){var self=this;if(opts&&null!==opts)for(var key in opts)this[key]=opts[key];marketHolder=opts&&opts.holder?this.holder:$("#mkt-snap .market-data .stocks"),0!==marketHolder.length&&(marketHolder.closest("#mkt-snap").length>0&&marketHolder.closest("#mkt-snap").css("display","block"),MARKET_FUTURES.isFutures()?(clearStocks.call(self,marketHolder),MARKET_FUTURES.getData(function(data){Proto.getFuturesData(marketHolder,data)}),setInterval(function(){MARKET_FUTURES.getData(function(data){Proto.getFuturesData(marketHolder,data)})},6e4)):(clearStocks.call(self,marketHolder),Proto.getMarketFeed(marketHolder),setInterval(function(){Proto.getMarketFeed(marketHolder)},6e4)),setLinks(marketHolder))},Proto.getMarketFeed=function(parent){var ticker,self=this,stock=parent.find(".stock"),stockHolder=[],futures=!!MARKET_FUTURES.isFutures();stock.each(function(){var el=$(this);ticker=el.attr("data-stock-ticker"),defaultStocks.indexOf(ticker)>-1&&futures||(stockHolder.push(ticker),checkMarketElements.call(self,el))}),Proto.getData(stockHolder,function(data){Proto.setMarketData(parent.closest(".market-data"),data,stockHolder,stock)})},Proto.getData=function(arr,callback){function loadStack(data){for(;CALL_STACK[id].length>0;)CALL_STACK[id].shift()(data)}if(arr&&callback){var id="getData"+arr.join("").replace(/[^A-Za-z0-9]+/gi,"ii");if(CALL_STACK[id])return void CALL_STACK[id].push(callback);CALL_STACK[id]=[],CALL_STACK[id].push(callback);var url="//www.foxbusiness.com/ajax/quote/"+arr.join(",");$.ajax({url:url,data:{cb:cacheBuster(2)},dataType:"jsonp",jsonpCallback:id,async:!0,cache:!0}).done(function(data){loadStack(data)})}},Proto.setMarketData=function(el,data,stockArr,stocksEl){var self=this,marketInfo=normalize(data,stockArr);stocksEl.each(function(){var $self=$(this),current=$self.find(".current"),name=$self.find(".name"),change=$self.find(".change"),percent=$self.find(".percent"),headerName=$self.find("a"),headerPercent=headerName.find("span"),ticker=$self.attr("data-stock-ticker"),titleOverride=$self.attr("data-stock-title");void 0!==marketInfo[ticker]&&(self.header?(getText(headerName)!==marketInfo[ticker].name&&(clearText(headerName),headerName.prepend(marketInfo[ticker].name+" ")),headerPercent.text(marketInfo[ticker].percentChange)):(name.html(marketInfo[ticker].name),current.html(marketInfo[ticker].current),change.html(marketInfo[ticker].netChange),percent.html(marketInfo[ticker].percentChange),""!==titleOverride&&name.html(titleOverride)),checkPosNegVal.call(self,self.header?el.find("ul"):el.find(".stocks")))})},Proto.getFuturesData=function(el,data){var self=this;el.find(".stock").each(function(){var stock=$(this),sym=stock.attr("data-stock-ticker");checkMarketElements.call(self,$(this)),defaultStocks.indexOf(sym)>-1?(Proto.setFuturesData(stock,sym,data),checkPosNegVal.call(self,null,stock)):Proto.getMarketFeed(el)})},Proto.setFuturesData=function(stock,sym,data){function idx(val,obj){return obj.name.indexOf(val)>-1}function setValues(obj){self.header?stock.find("a > span").text(obj.pct):(stock.find(".percent").html(obj.pct),stock.find(".current").html(obj.val),stock.find(".change").html(obj.pts))}var self=this;self.header?_(data).forEach(function(obj){idx("E-MINI DOW",obj)&&"I:DJI"===sym?("DJIA"!==getText(stock.find("a"))&&(clearText(stock.find("a")),stock.find("a").prepend("DJIA ")),setValues(obj)):(idx("E-MINI S&P 500",obj)||idx("E-MINI S&amp;P 500",obj))&&"SP500"===sym?("S&P 500"!==getText(stock.find("a"))&&(clearText(stock.find("a")),stock.find("a").prepend("S&P 500 ")),setValues(obj)):idx("E-MINI NASDAQ",obj)&&"I:COMP"===sym&&("NASDAQ"!==getText(stock.find("a"))&&(clearText(stock.find("a")),stock.find("a").prepend("NASDAQ 100".replace(/\d+/g,""))),setValues(obj))}):_(data).forEach(function(obj){idx("E-MINI DOW",obj)&&"I:DJI"===sym?(stock.find(".name").html("DJIA"),setValues(obj)):idx("E-MINI S&P 500",obj)&&"SP500"===sym?(stock.find(".name").html("S&P 500"),setValues(obj)):idx("E-MINI NASDAQ",obj)&&"I:COMP"===sym&&(stock.find(".name").html("NASDAQ 100".replace(/ \d+/g,"")),setValues(obj))})}}function checkMarketElements(el){var self=this,marketTemplate=self&&self.header?'<a href="#"><span class=""></span></a>':'<span class="name"></span>                <span class="current"></span>                <span class="change"></span>                <span class="percent"></span>';(!self.header&&0===el.find(".name").length||self.header&&0===el.find("a").length)&&el.append(marketTemplate)}function checkPosNegVal(el,stock){var self=this;(stock&&stock.length>0?stock:el.find(".stock")).each(function(){var $self=$(this),$pctEl=self.header?$self.find("a span"):$self.find(".percent"),pct=$pctEl.text();self.header?($pctEl.removeClass("pos neg"),/\+/.test(pct)?$pctEl.addClass("pos"):$pctEl.addClass("neg")):($self.removeClass("pos neg"),/\+/.test(pct)?$self.addClass("pos"):$self.addClass("neg"))})}function cacheBuster(freq){freq=freq||!1;var date=new Date,str=date.getFullYear().toString()+(date.getMonth()+1).toString()+date.getDate().toString(),hr=date.getHours()+1,min=date.getMinutes();return str+=hr.toString()+(freq&&!isNaN(freq)?Math.floor(min/parseInt(freq,10)).toString():"")}function renameTicker(sym,desc){if("Crude Oil"===desc)return sym="FUT-CL";switch(sym){case"I:DJI":sym="DJIA";break;case"I:COMP":sym="NASDAQ";break;case"SP500":sym="S&P 500";break;case"FUT-GC":sym="GOLD";break;case"CLU16":case"CLV16":sym="FUT-CL"}return sym}function normalize(data,stockArr){var quoteBase,symbol,quotes=$.isArray(data.quote)?data.quote:[data.quote],i=0,info={};for(stockArr=stockArr||[],i;i<quotes.length;i++)quoteBase=quotes[i],symbol=quoteBase.ticker,desc=quoteBase.description,(["CLU16","CLV16"].indexOf(symbol)>-1||"Crude Oil"===desc)&&(symbol=renameTicker(symbol,desc)),"n.a."!==symbol&&(info[symbol]={},info[symbol].current=quoteBase.current,info[symbol].percentChange=quoteBase.percentChange,info[symbol].netChange=quoteBase.netChange,info[symbol].name=renameTicker(symbol,desc));return info}function clearStocks(el){var self=this;el.find(".stock").each(function(){var stock=$(this);0!==stock.children().length&&(self&&self.header?clearText(stock.find("a > span")):stock.find(".name, .current, .change, .percent").empty())})}function clearText($el){$el.contents().filter(function(){return 3===this.nodeType}).remove()}function setLinks(el){el.find(".stock").each(function(){var stock=$(this),sym=stock.attr("data-stock-ticker"),link="//www.foxbusiness.com/quote.html?stockTicker="+sym;void 0!==stock.attr("data-stock-url")&&""!==stock.attr("data-stock-url")&&(link=stock.attr("data-stock-url")),stock.on("click",function(evt){evt.preventDefault(),link&&window.open(link,"_blank")})})}function getText($el){var text=$el.contents().filter(function(){return 3===this.nodeType})[0];return!!text&&text.nodeValue}var MARKET_FUTURES=require("MarketFutures");return new App});