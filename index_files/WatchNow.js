/*! updated; 02-27-2018 04:46 PM **/


Modulr.define("core.plugins:WatchNow",["jquery","MultiFeedParser","AKAMAI_TIME_HELPER","DateTime"],function($,MultiFeedParser,AKAMAI_TIME_HELPER,DateTime){var CONST={};CONST.feeds={},CONST.feeds.FN={"sched-tool":"//www.foxnews.com/feeds/schedule/channel/foxnewscom-live/feed/json",playlist:"//interactive.foxnews.com/projects/watch-now/live.js"},CONST.feeds.FNL={"sched-tool":"//www.foxnews.com/feeds/schedule/channel/foxnewscom-live/feed/json",playlist:"//video.foxnews.com/v/feed/playlist/5218470496001.js?template=fox"},CONST.feeds.FB={"sched-tool":"//www.foxbusiness.com/feeds/watch/show-schedule/feed/json/",playlist:"//video.foxbusiness.com/v/feed/playlist/932683241001.js?template=fox"},CONST.feeds.SBC={"sched-tool":"//www.foxbusiness.com/feeds/watch/show-schedule/feed/json/",playlist:"//video.foxbusiness.com/v/feed/playlist/937116525001.js?template=fox"},CONST.config={},CONST.config.imageDimension=[132,74],CONST.config.imagePattern="/static/p/video/img/live/schedule/144x81-live-${machineTitle}.jpg";var App=function(config){var self=this;self.__vars={};var v=self.__vars;v.data={},config=config&&"object"==typeof config&&!$.isArray(config)?config:{},v._config=config,config.parserOnly||setFeedParser(v)};App.prototype.getData=function(callback){var self=this,v=self.__vars,parserOnly=!(!v._config||!v._config.parserOnly);if("function"!=typeof callback||parserOnly)return!1;v._parser.event.onLoad("sched-tool",function(schedData){v.data["sched-tool"]=schedData,v._parser.event.getData("playlist",function(playlistData){v.data.playlist=playlistData;var normalize=normalizeBoth(schedData,playlistData);callback(normalize)})})},App.prototype.getScheduleFeed=function(callback){var self=this,v=self.__vars,parserOnly=!(!v._config||!v._config.parserOnly);if("function"!=typeof callback||parserOnly)return!1;v._parser.event.onLoad("sched-tool",function(data){v.data["sched-tool"]=data,callback(data)})},App.prototype.getPlaylistFeed=function(callback){var self=this,v=self.__vars,parserOnly=!(!v._config||!v._config.parserOnly);if("function"!=typeof callback||parserOnly)return!1;v._parser.event.onLoad("playlist",function(data){v.data.playlist=data,callback(data)})},App.prototype.parseScheduleData=function(feedData,config,full){return normalizeSchedTool(feedData,config,full)};var setFeedParser=function(vars){var config=vars._config,feed=CONST.feeds.FN;"foxbusiness"===config.site?feed=CONST.feeds.FB:"smallbusiness"===config.site?feed=CONST.feeds.SBC:"latino"===config.site&&(feed=CONST.feeds.FNL);var refresh=!1;config.refresh&&!isNaN(config.refresh)&&(refresh=parseInt(config.refresh,10));var feedConfig={};feedConfig.feeds={},feedConfig.logging=!0,feedConfig.initOnLoad=!0,refresh&&(feedConfig.cacheTime=refresh),feedConfig.feeds.playlist={url:feed.playlist,jsonpCallback:"FOX_WatchNowPlaylist",normalize:function(data){var ret=data;return data&&(ret=normalizePlaylist(config,data)),ret}},feedConfig.feeds["sched-tool"]={url:feed["sched-tool"],jsonpCallback:"FOX_WatchNowSchedTool",normalize:function(data){var ret=data,full=!!config.fullSchedule;return data&&(ret=normalizeSchedTool(data,config,full)),ret}},vars._parser=new MultiFeedParser(feedConfig)},normalizeBoth=function(sched,playlist){var len=playlist.length>999?999:playlist.length,arr=[];sched&&arr.push(sched);for(var cntr=0,liveArr=[];cntr<playlist.length;)playlist[cntr]&&playlist[cntr].isLive?(liveArr.push(playlist[cntr]),playlist.splice(cntr,1)):cntr+=1;for(playlist.reverse(),liveArr.reverse(),playlist=playlist.concat(liveArr),playlist.reverse(),x=0;x<len;x+=1)arr.push(playlist[x]);return arr.length%2!=0&&arr.pop(),arr},normalizePlaylist=function(config,data){var info=!!(data&&data.channel&&data.channel.item)&&data.channel.item;if(!info)return!1;info=$.isArray(info)?info:[info];var x,arr=[],len=info.length,dim=config.imageDimension?config.imageDimension:CONST.config.imageDimension,isLive=function(val){var ret=!1;if(val){val=$.isArray(val)?val:[val];for(var i=0;i<val.length;i+=1)if(val[i].indexOf("live_stream")>-1){ret=!0;break}}return ret};for(x=0;x<len;x+=1)arr.push(function(item){var img=setResizerDimension(item["media-group"]["media-thumbnail"]["@attributes"].url,dim);return{isLive:isLive(item.category),title:item.title,link:item.link,guid:item.guid,img:img,raw:item}}(info[x]));return arr},normalizeSchedTool=function(data,config,full){var x,ret,arr=[],latest=[],currentShow=!1,items=data.day,nowDate=AKAMAI_TIME_HELPER.getCurrent(),maxLatestLen=config&&config.maxLatest?config.maxLatest:3,pushShow=function(showInfo,idx,isCurrent){isCurrent=isCurrent||!1,latest.push({current:isCurrent,show:showInfo,index:idx})};for(x=0;x<items.length;x+=1)!function(item){var z,shows=item.show||[];for(shows=$.isArray(shows)?shows:[shows],z=0;z<shows.length;z+=1){var show=shows[z];show.start=setSchedTime(show.start),show.end=setSchedTime(show.end),show.description="string"!=typeof show.description?"":$("<div></div>").text(show.description).text(),show.showImg=function(macTitle,custom){macTitle="string"==typeof macTitle?$.trim(macTitle):"";var ret="//global.fncstatic.com/static/v/all/img/clear.gif",dim=config.imageDimension?config.imageDimension:CONST.config.imageDimension;if(custom)ret=setImageResizer(custom,dim);else if(macTitle.length>0){var pat,macImg="//global.fncstatic.com";config.imagePatternFull?(pat=config.imagePatternFull,pat=pat.replace("${machineTitle}",macTitle),macImg=pat):config.imagePattern?(pat=config.imagePattern,pat=pat.replace("${machineTitle}",macTitle),macImg+=pat):macImg+=CONST.config.imagePattern.replace("${machineTitle}",macTitle),ret=setImageResizer(macImg,dim)}return ret}(show["machine-title"],show.image),arr.push(show),show.start_early=new Date(show.start.getTime()-3e5),!currentShow&&show.start_early<=nowDate&&show.end>=nowDate?(latest=[],pushShow(show,arr.length-1,!0),currentShow=!0):latest.length<maxLatestLen&&currentShow?pushShow(show,arr.length-1):latest.length<maxLatestLen&&show.start>=nowDate&&pushShow(show,arr.length-1)}}(items[x]);ret={latest:latest,normalized:arr,raw:data};var norm={};return latest=!!(ret&&ret.latest[0]&&ret.latest[0].current)&&ret.latest[0].show,latest?(norm={title:latest.title,img:latest.showImg,isLive:!0,link:latest.link,guid:latest["machine-title"],webShow:!0,raw:latest,rawDump:ret},ret=norm):full?(norm={rawDump:ret},ret=norm):ret=latest,ret},setResizerDimension=function(url,dim){if(!dim)return url;var arr=url.split("/"),len=arr.length,width=arr[len-3],height=arr[len-2];return arr[len-3]=isNaN(width)?width:dim[0],arr[len-2]=isNaN(height)?height:dim[1],arr.join("/")},setImageResizer=function(url,dim){if(!dim)return url;var src=url.replace("//",""),arr=src.split("/"),len=arr.length;return arr[len-1]=dim.join("/")+"/"+arr[len-1],"//a57.foxnews.com/"+arr.join("/")},setSchedTime=function(val){var ret;if(val instanceof Date)ret=val;else{var sp=val.indexOf("T")>-1?val.split("T"):val.split(" "),date=sp[0],time=sp[1].split("-")[0];date=date.split("-"),date=[date[1],date[2],date[0]].join("/"),ret=new Date([date,time].join(" "))}return ret};return App});